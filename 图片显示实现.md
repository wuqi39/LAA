# 图片显示实现机制

## 图片处理流程

LAA 助理的图片显示功能通过以下步骤实现：

1. **搜索景点信息**：使用高德地图API搜索景点信息
2. **获取图片链接**：从搜索结果中提取景点图片的URL
3. **下载并保存图片**：将图片下载到本地的 resource/images 目录
4. **生成HTML显示**：使用 `<img>` 标签在响应中显示图片

## 核心实现代码

图片处理主要在 `mcp_services.py` 文件中的 `download_and_save_image` 函数实现：

```python
def download_and_save_image(image_url: str, filename: str = None) -> str:
    """
    Download and save image to local storage
    
    Args:
        image_url: Image URL
        filename: Optional filename, automatically generated if not provided
    
    Returns:
        Relative path to the local image file
    """
    try:
        import hashlib
        import requests

        # If no filename is provided, generate from URL
        if not filename:
            url_hash = hashlib.md5(image_url.encode()).hexdigest()[:8]
            # Extract file extension from URL
            ext = '.jpg'  # Default extension
            if '.' in image_url.split('/')[-1]:
                ext = '.' + image_url.split('.')[-1].split('?')[0]
            filename = f"img_{url_hash}{ext}"
        
        # Ensure filename is safe
        safe_filename = "".join(c for c in filename if c.isalnum() or c in ('.', '_', '-'))
        if not safe_filename:
            safe_filename = f"image_{hash(image_url)}.jpg"
        
        local_path = os.path.join(IMAGES_DIR, safe_filename)
        
        # If file exists, return path directly
        if os.path.exists(local_path):
            return f"/resource/images/{safe_filename}"
        
        # Download image
        response = requests.get(image_url, timeout=10)
        if response.status_code == 200:
            with open(local_path, 'wb') as f:
                f.write(response.content)
            return f"/resource/images/{safe_filename}"
        else:
            return None
    except Exception as e:
        print(f"Failed to download image: {str(e)}")
        return None
```

## 主要图片相关功能

1. **search_attractions** - 景点搜索工具
   - 搜索指定地点的景点信息
   - 获取景点图片链接
   - 在响应中显示图片

2. **around_search_attractions** - 周边景点搜索工具
   - 搜索指定位置周边的景点
   - 支持按半径搜索
   - 提供景点图片

3. **search_attractions_with_images** - 带图片的景点搜索工具
   - 结合Bing搜索和高德地图获取景点详情
   - 提供景点图片链接

## 图片存储结构

```
/resource/
  └── images/
      ├── img_abc12345.jpg
      ├── img_def67890.png
      └── ...
```

## 图片显示格式

在响应中以如下HTML格式显示图片：

```html
<img src='/resource/images/img_abc12345.jpg' alt='景点图片' style='max-width: 300px; max-height: 200px;'>
```

## 图片处理限制

1. 图片下载超时时间：10秒
2. 图片最大显示尺寸：300px x 200px
3. 支持的图片格式：从URL中自动识别扩展名
4. 重复图片的缓存机制：如果已存在则直接返回路径

## 静态文件服务

图片显示需要启动静态文件服务，LAA.py 中包含以下配置：

```python
def start_static_server():
    # 创建Flask应用提供/resource/目录下的静态文件访问
    ...
```

在启动GUI或地图模式时会自动启动该服务，使图片能够正确显示。